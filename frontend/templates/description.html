<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>AI Product Analysis</title>
		<style>
			:root {
				--bg-primary: #0f0f23;
				--bg-secondary: #1a1a2e;
				--bg-card: rgba(255, 255, 255, 0.05);
				--text-primary: #ffffff;
				--text-secondary: #a0a0a0;
				--accent-primary: #6366f1;
				--accent-secondary: #8b5cf6;
				--accent-tertiary: #06b6d4;
				--border: rgba(255, 255, 255, 0.1);
				--shadow: rgba(0, 0, 0, 0.3);
				--success: #10b981;
				--warning: #f59e0b;
				--error: #ef4444;
			}

			[data-theme="light"] {
				--bg-primary: #ffffff;
				--bg-secondary: #f8fafc;
				--bg-card: rgba(0, 0, 0, 0.02);
				--text-primary: #1e293b;
				--text-secondary: #64748b;
				--accent-primary: #6366f1;
				--accent-secondary: #8b5cf6;
				--accent-tertiary: #06b6d4;
				--border: rgba(0, 0, 0, 0.1);
				--shadow: rgba(0, 0, 0, 0.1);
				--success: #10b981;
				--warning: #f59e0b;
				--error: #ef4444;
			}

			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
					sans-serif;
				background: var(--bg-primary);
				color: var(--text-primary);
				min-height: 100vh;
				transition: all 0.3s ease;
			}

			.theme-toggle {
				position: fixed;
				top: 2rem;
				right: 2rem;
				z-index: 1000;
				background: var(--bg-card);
				border: 1px solid var(--border);
				border-radius: 50px;
				padding: 0.5rem;
				cursor: pointer;
				transition: all 0.3s ease;
				backdrop-filter: blur(10px);
			}

			.theme-toggle:hover {
				transform: scale(1.1);
				box-shadow: 0 8px 32px var(--shadow);
			}

			.theme-toggle svg {
				width: 24px;
				height: 24px;
				fill: var(--text-primary);
				transition: all 0.3s ease;
			}

			.container {
				max-width: 1200px;
				margin: 0 auto;
				padding: 2rem;
				min-height: 100vh;
			}

			.header {
				text-align: center;
				margin-bottom: 3rem;
				animation: slideDown 0.8s ease-out;
			}

			@keyframes slideDown {
				from {
					opacity: 0;
					transform: translateY(-30px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.header h1 {
				font-size: 3rem;
				font-weight: 700;
				margin-bottom: 1rem;
				background: linear-gradient(
					135deg,
					var(--accent-primary),
					var(--accent-secondary)
				);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
			}

			.header p {
				color: var(--text-secondary);
				font-size: 1.2rem;
				max-width: 600px;
				margin: 0 auto;
			}

			.back-btn {
				background: var(--bg-card);
				color: var(--text-primary);
				border: 1px solid var(--border);
				padding: 0.75rem 1.5rem;
				border-radius: 12px;
				text-decoration: none;
				font-weight: 500;
				transition: all 0.3s ease;
				display: inline-flex;
				align-items: center;
				gap: 0.5rem;
				margin-bottom: 2rem;
				backdrop-filter: blur(10px);
			}

			.back-btn:hover {
				background: var(--accent-primary);
				color: white;
				transform: translateY(-2px);
				box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
			}

			.main-content {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 2rem;
				animation: slideUp 0.8s ease-out 0.2s both;
			}

			@keyframes slideUp {
				from {
					opacity: 0;
					transform: translateY(30px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.upload-section,
			.results-section {
				background: var(--bg-card);
				border: 1px solid var(--border);
				border-radius: 20px;
				padding: 2rem;
				backdrop-filter: blur(20px);
				box-shadow: 0 16px 32px var(--shadow);
			}

			.upload-area {
				border: 2px dashed var(--border);
				border-radius: 16px;
				padding: 3rem 2rem;
				text-align: center;
				cursor: pointer;
				transition: all 0.3s ease;
				background: var(--bg-card);
				margin: 1.5rem 0;
			}

			.upload-area:hover {
				border-color: var(--accent-primary);
				background: rgba(99, 102, 241, 0.05);
				transform: translateY(-2px);
			}

			.btn {
				background: linear-gradient(
					135deg,
					var(--accent-primary),
					var(--accent-secondary)
				);
				color: white;
				border: none;
				padding: 1rem 2rem;
				border-radius: 12px;
				font-weight: 600;
				font-size: 1rem;
				cursor: pointer;
				transition: all 0.3s ease;
				box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
				position: relative;
				overflow: hidden;
				width: 100%;
				margin-top: 1.5rem;
			}

			.btn:hover {
				transform: translateY(-2px);
				box-shadow: 0 16px 48px rgba(99, 102, 241, 0.4);
			}

			.btn:disabled {
				background: var(--text-secondary);
				cursor: not-allowed;
				transform: none;
				box-shadow: none;
			}

			.loading {
				text-align: center;
				padding: 3rem 2rem;
				animation: pulse 2s ease-in-out infinite;
			}

			@keyframes pulse {
				0%,
				100% {
					opacity: 1;
				}
				50% {
					opacity: 0.6;
				}
			}

			.loading-spinner {
				width: 48px;
				height: 48px;
				margin: 0 auto 1rem;
				border: 4px solid var(--border);
				border-top: 4px solid var(--accent-primary);
				border-radius: 50%;
				animation: spin 1s linear infinite;
			}

			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}

			.result-item {
				background: var(--bg-card);
				border: 1px solid var(--border);
				border-radius: 12px;
				padding: 1.5rem;
				margin: 1rem 0;
				transition: all 0.3s ease;
				animation: slideInRight 0.5s ease-out;
			}

			@keyframes slideInRight {
				from {
					opacity: 0;
					transform: translateX(20px);
				}
				to {
					opacity: 1;
					transform: translateX(0);
				}
			}

			.result-item:hover {
				transform: translateY(-2px);
				box-shadow: 0 8px 32px var(--shadow);
			}

			.result-label {
				font-weight: 700;
				color: var(--accent-primary);
				margin-bottom: 0.5rem;
				font-size: 1rem;
				text-transform: uppercase;
				letter-spacing: 0.5px;
			}

			.result-value {
				font-size: 1.1rem;
				line-height: 1.5;
				color: var(--text-primary);
			}

			.secondary-characteristic {
				color: var(--text-secondary);
				font-size: 0.95rem;
				font-weight: 500;
			}

			.confidence-bar {
				width: 100%;
				height: 4px;
				background: var(--border);
				border-radius: 2px;
				margin-top: 0.5rem;
				overflow: hidden;
			}

			.confidence-fill {
				height: 100%;
				background: linear-gradient(
					90deg,
					var(--accent-primary),
					var(--accent-secondary)
				);
				border-radius: 2px;
				transition: width 0.5s ease;
			}

			.error {
				background: rgba(239, 68, 68, 0.1);
				border: 1px solid var(--error);
				color: var(--error);
				padding: 1.5rem;
				border-radius: 12px;
				margin: 1rem 0;
			}

			@media (max-width: 768px) {
				.main-content {
					grid-template-columns: 1fr;
				}
				.header h1 {
					font-size: 2rem;
				}
				.container {
					padding: 1rem;
				}
			}
		</style>
	</head>
	<body>
		<div class="theme-toggle" onclick="toggleTheme()">
			<svg class="sun-icon" viewBox="0 0 24 24">
				<circle cx="12" cy="12" r="5" />
				<path
					d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
				/>
			</svg>
		</div>

		<div class="container">
			<div class="header">
				<h1>AI Product Analysis</h1>
				<p>
					Upload an image and let our advanced AI analyze and describe the item
					with detailed insights
				</p>
			</div>

			<a href="/" class="back-btn">
				<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
					<path
						d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"
					/>
				</svg>
				Back to Home
			</a>

			<div class="main-content">
				<div class="upload-section">
					<h3 style="margin-bottom: 1.5rem; color: var(--text-primary)">
						Upload Image
					</h3>

					<div
						class="upload-area"
						onclick="document.getElementById('fileInput').click()"
						ondrop="handleDrop(event)"
						ondragover="handleDragOver(event)"
						ondragleave="handleDragLeave(event)"
					>
						<div
							style="
								width: 64px;
								height: 64px;
								margin: 0 auto 1rem;
								background: linear-gradient(
									135deg,
									var(--accent-primary),
									var(--accent-secondary)
								);
								border-radius: 16px;
								display: flex;
								align-items: center;
								justify-content: center;
							"
						>
							<svg
								viewBox="0 0 24 24"
								style="width: 32px; height: 32px; fill: white"
							>
								<path
									d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"
								/>
							</svg>
						</div>
						<p
							style="
								font-size: 1.1rem;
								margin-bottom: 0.5rem;
								color: var(--text-primary);
							"
						>
							<span id="uploadText"
								>Drop your image here or click to browse</span
							>
						</p>
						<p style="color: var(--text-secondary); font-size: 0.9rem">
							Supports JPG, PNG, GIF, WebP • Max 10MB
						</p>
						<input
							type="file"
							id="fileInput"
							accept="image/*"
							style="display: none"
							onchange="handleFileSelect(event)"
						/>
					</div>

					<div
						id="imagePreview"
						style="
							display: none;
							margin-top: 2rem;
							text-align: center;
							animation: fadeIn 0.5s ease-out;
						"
					>
						<h4 style="margin-bottom: 1rem; color: var(--text-primary)">
							Selected Image
						</h4>
						<img
							id="previewImg"
							style="
								max-width: 100%;
								max-height: 300px;
								border-radius: 16px;
								box-shadow: 0 16px 32px var(--shadow);
								border: 2px solid var(--border);
							"
							alt="Preview"
						/>
					</div>

					<button
						id="generateBtn"
						class="btn"
						onclick="generateDescription()"
						disabled
					>
						Analyze Image
					</button>
				</div>

				<div class="results-section">
					<h3 style="margin-bottom: 1.5rem; color: var(--text-primary)">
						Analysis Results
					</h3>

					<div id="loading" style="display: none">
						<div class="loading">
							<div class="loading-spinner"></div>
							<p id="loadingStatus" style="color: var(--text-secondary)">
								AI is analyzing your image...
							</p>
							<p
								id="loadingSubtext"
								style="
									color: var(--text-secondary);
									font-size: 0.9rem;
									margin-top: 0.5rem;
								"
							>
								This may take 10-30 seconds
							</p>
						</div>
					</div>

					<div id="results" style="display: none">
						<div id="resultContent"></div>
					</div>

					<div
						id="placeholder"
						style="
							text-align: center;
							padding: 3rem 2rem;
							color: var(--text-secondary);
						"
					>
						<svg
							width="64"
							height="64"
							viewBox="0 0 24 24"
							fill="currentColor"
							style="opacity: 0.3; margin-bottom: 1rem"
						>
							<path
								d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M7,13H17V11H7"
							/>
						</svg>
						<p>Upload an image to see AI analysis results here</p>
					</div>
				</div>
			</div>
		</div>

		<script>
			let selectedFile = null;

			// Theme toggle functionality
			function toggleTheme() {
				const html = document.documentElement;
				const currentTheme = html.getAttribute("data-theme");
				const newTheme = currentTheme === "light" ? "dark" : "light";
				html.setAttribute("data-theme", newTheme);
				localStorage.setItem("theme", newTheme);
			}

			// Load saved theme
			const savedTheme = localStorage.getItem("theme") || "dark";
			document.documentElement.setAttribute("data-theme", savedTheme);

			// Drag and drop functionality
			function handleDragOver(event) {
				event.preventDefault();
				event.currentTarget.classList.add("dragover");
			}

			function handleDragLeave(event) {
				event.currentTarget.classList.remove("dragover");
			}

			function handleDrop(event) {
				event.preventDefault();
				event.currentTarget.classList.remove("dragover");
				const files = event.dataTransfer.files;
				if (files.length > 0) {
					selectedFile = files[0];
					updateFileSelection();
				}
			}

			function handleFileSelect(event) {
				selectedFile = event.target.files[0];
				updateFileSelection();
			}

			function updateFileSelection() {
				if (selectedFile) {
					document.getElementById("generateBtn").disabled = false;
					document.getElementById(
						"uploadText"
					).textContent = `Selected: ${selectedFile.name}`;
					document.getElementById("placeholder").style.display = "none";

					// Show image preview
					const reader = new FileReader();
					reader.onload = function (e) {
						document.getElementById("previewImg").src = e.target.result;
						document.getElementById("imagePreview").style.display = "block";
					};
					reader.readAsDataURL(selectedFile);
				}
			}

			async function generateDescription() {
				if (!selectedFile) return;

				const formData = new FormData();
				formData.append("file", selectedFile);

				document.getElementById("loading").style.display = "block";
				document.getElementById("results").style.display = "none";
				document.getElementById("placeholder").style.display = "none";
				document.getElementById("generateBtn").disabled = true;

				// Step 1: Check for multiple objects
				document.getElementById("loadingStatus").textContent =
					"Checking for multiple objects in the image...";
				document.getElementById("loadingSubtext").textContent = "Step 1 of 2";

				let multipleObjectsMsg = "";

				try {
					// First API call - check for multiple objects
					const multipleCheckResponse = await fetch(
						"/api/check-multiple-objects",
						{
							method: "POST",
							body: formData,
						}
					);

					const multipleCheckResult = await multipleCheckResponse.json();

					if (multipleCheckResult.success) {
						const moData = multipleCheckResult.data;
						if (moData.multiple_objects) {
							multipleObjectsMsg = `⚠️ Multiple objects detected: ${moData.brief_description}. Analysis may take longer.`;
						} else {
							multipleObjectsMsg = `✓ Single object detected: ${moData.brief_description}`;
						}

						// Show the multiple objects result immediately
						const resultContent = document.getElementById("resultContent");
						resultContent.innerHTML = "";
						document.getElementById("results").style.display = "block";

						const msgDiv = document.createElement("div");
						msgDiv.className = "multiple-objects-msg";
						msgDiv.style.cssText = `
							background: var(--bg-card);
							border: 1px solid var(--border);
							border-radius: 12px;
							padding: 1rem;
							margin-bottom: 1.5rem;
							color: var(--text-primary);
							animation: slideInRight 0.5s ease-out;
						`;
						msgDiv.textContent = multipleObjectsMsg;
						resultContent.appendChild(msgDiv);
					}

					// Step 2: Generate full description
					document.getElementById("loadingStatus").textContent =
						"Analyzing item details...";
					document.getElementById("loadingSubtext").textContent = "Step 2 of 2";

					// Create new FormData for second request
					const formData2 = new FormData();
					formData2.append("file", selectedFile);

					const response = await fetch("/api/generate-description", {
						method: "POST",
						body: formData2,
					});

					const result = await response.json();

					document.getElementById("loading").style.display = "none";
					document.getElementById("generateBtn").disabled = false;

					if (result.success) {
						displayResults(result.data, multipleObjectsMsg);
					} else {
						displayError(result.error, result.raw_response);
					}
				} catch (error) {
					document.getElementById("loading").style.display = "none";
					document.getElementById("generateBtn").disabled = false;
					displayError("Network error: " + error.message);
				}
			}

			// ChatGPT-style typewriter effect
			function typeWriter(element, text, speed = 30) {
				return new Promise((resolve) => {
					let i = 0;
					element.innerHTML = "";
					const timer = setInterval(() => {
						if (i < text.length) {
							element.innerHTML += text.charAt(i);
							i++;
						} else {
							clearInterval(timer);
							resolve();
						}
					}, speed);
				});
			}

			async function displayResults(data, multipleObjectsMsg = "") {
				const resultContent = document.getElementById("resultContent");

				// Check if there's already a multiple objects message, preserve it
				const existingMsg = resultContent.querySelector(
					".multiple-objects-msg"
				);

				resultContent.innerHTML = "";

				// Show results container
				document.getElementById("results").style.display = "block";

				// Re-add the existing message or add a new one
				if (existingMsg) {
					resultContent.appendChild(existingMsg);
				} else if (multipleObjectsMsg) {
					const msgDiv = document.createElement("div");
					msgDiv.className = "multiple-objects-msg";
					msgDiv.style.cssText = `
						background: var(--bg-card);
						border: 1px solid var(--border);
						border-radius: 12px;
						padding: 1rem;
						margin-bottom: 1.5rem;
						color: var(--text-primary);
						animation: slideInRight 0.5s ease-out;
					`;
					msgDiv.textContent = multipleObjectsMsg;
					resultContent.appendChild(msgDiv);
				}

				const items = [];

				// Handle the new JSON format from your prompt
				if (data.fields) {
					const fields = data.fields;
					const confidence = data.confidence || {};
					const evidence = data.evidence || {};

					// Build color value with secondary
					let colorValue = fields.colour || "N/A";
					if (
						fields.colour_secondary &&
						fields.colour_secondary.color &&
						fields.colour_secondary.color !== "null" &&
						fields.colour_secondary.percentage > 0
					) {
						colorValue += ` + ${fields.colour_secondary.color} (${fields.colour_secondary.percentage}%)`;
					}

					// Build material value with secondary
					let materialValue = fields.material || "N/A";
					if (
						fields.material_secondary &&
						fields.material_secondary.material &&
						fields.material_secondary.material !== "null" &&
						fields.material_secondary.percentage > 0
					) {
						materialValue += ` + ${fields.material_secondary.material} (${fields.material_secondary.percentage}%)`;
					}

					items.push(
						{
							label: "Description",
							value: data.description || "N/A",
							confidence: null,
						},
						{
							label: "Brand",
							value: fields.brand || "Not identified",
							confidence: confidence.brand,
						},
						{
							label: "Model",
							value: fields.model || "Not identified",
							confidence: confidence.model,
						},
						{
							label: "Condition",
							value: fields.condition || "N/A",
							confidence: confidence.condition,
						},
						{
							label: "Color",
							value: colorValue,
							confidence: confidence.colour,
							hasSecondary:
								fields.colour_secondary?.color &&
								fields.colour_secondary.color !== "null" &&
								fields.colour_secondary.percentage > 0,
						},
						{
							label: "Material",
							value: materialValue,
							confidence: confidence.material,
							hasSecondary:
								fields.material_secondary?.material &&
								fields.material_secondary.material !== "null" &&
								fields.material_secondary.percentage > 0,
						},
						{
							label: "Category",
							value: fields.category || "N/A",
							confidence: confidence.category,
						},
						{
							label: "Weight",
							value: fields.weight?.value
								? `${fields.weight.value} ${fields.weight.unit}`
								: "Not specified",
							confidence: confidence.weight,
						},
						{
							label: "Print Label",
							value: fields.print_label ? "Yes" : "No",
							confidence: confidence.print_label,
						},
						{
							label: "Sort Classification",
							value: fields.sort || "N/A",
							confidence: confidence.sort,
						},
						{
							label: "Additional Info",
							value: fields.additional_info || "N/A",
							confidence: null,
						},
						{
							label: "OCR Text",
							value: evidence.ocr_like_text || "None detected",
							confidence: null,
						},
						{
							label: "Visible Marks",
							value: evidence.visible_marks || "None noted",
							confidence: null,
						},
						{
							label: "Needs Review",
							value: data.needs_review ? "Yes" : "No",
							confidence: null,
						}
					);
				} else {
					// Fallback for old format
					items.push(
						{ label: "Title", value: data.title || "N/A", confidence: null },
						{
							label: "Description",
							value: data.description || "N/A",
							confidence: null,
						},
						{
							label: "Condition",
							value: data.condition || "N/A",
							confidence: null,
						},
						{ label: "Color", value: data.color || "N/A", confidence: null },
						{
							label: "Material",
							value: data.material || "N/A",
							confidence: null,
						},
						{
							label: "Category",
							value: data.category || "N/A",
							confidence: null,
						},
						{
							label: "Confidence",
							value: `${data.confidence || "N/A"}/10`,
							confidence: null,
						},
						{
							label: "Evidence",
							value: data.evidence || "N/A",
							confidence: null,
						}
					);
				}

				// Animate each result item
				for (let i = 0; i < items.length; i++) {
					const item = items[i];
					const resultDiv = document.createElement("div");
					resultDiv.className = "result-item";
					resultDiv.style.animationDelay = `${i * 0.1}s`;

					const labelDiv = document.createElement("div");
					labelDiv.className = "result-label";
					labelDiv.textContent = item.label;

					const valueDiv = document.createElement("div");
					valueDiv.className = "result-value";

					resultDiv.appendChild(labelDiv);
					resultDiv.appendChild(valueDiv);

					if (item.confidence !== null && item.confidence !== undefined) {
						const confidenceBar = document.createElement("div");
						confidenceBar.className = "confidence-bar";
						const confidenceFill = document.createElement("div");
						confidenceFill.className = "confidence-fill";
						confidenceFill.style.width = "0%";
						confidenceBar.appendChild(confidenceFill);
						resultDiv.appendChild(confidenceBar);

						// Animate confidence bar after text
						setTimeout(() => {
							confidenceFill.style.width = `${(item.confidence * 100).toFixed(
								0
							)}%`;
						}, (i + 1) * 200 + 500);
					}

					resultContent.appendChild(resultDiv);

					// Typewriter effect for each value
					await new Promise((resolve) => setTimeout(resolve, i * 100));

					// Handle secondary characteristics styling
					if (item.hasSecondary && item.value.includes(" + ")) {
						const parts = item.value.split(" + ");
						const primaryPart = parts[0];
						const secondaryPart = parts[1];

						await typeWriter(valueDiv, primaryPart, 20);

						// Add secondary part with styling
						const secondarySpan = document.createElement("span");
						secondarySpan.className = "secondary-characteristic";
						secondarySpan.textContent = " + " + secondaryPart;
						valueDiv.appendChild(secondarySpan);
					} else {
						await typeWriter(valueDiv, item.value, 20);
					}
				}
			}

			function displayError(error, rawResponse = "") {
				const resultContent = document.getElementById("resultContent");
				resultContent.innerHTML = `
                <div class="error">
                    <h4>Error occurred:</h4>
                    <p>${error}</p>
                    ${
											rawResponse
												? `<details style="margin-top: 1rem;"><summary>Raw Response</summary><pre style="margin-top: 0.5rem; font-size: 0.8rem; white-space: pre-wrap;">${rawResponse}</pre></details>`
												: ""
										}
                </div>
            `;
				document.getElementById("results").style.display = "block";
			}
		</script>
	</body>
</html>
