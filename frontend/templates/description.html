<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>AI Product Analysis</title>
		<style>
			:root {
				--bg-primary: #0f0f23;
				--bg-secondary: #1a1a2e;
				--bg-card: rgba(255, 255, 255, 0.05);
				--text-primary: #ffffff;
				--text-secondary: #a0a0a0;
				--accent-primary: #6366f1;
				--accent-secondary: #8b5cf6;
				--accent-tertiary: #06b6d4;
				--border: rgba(255, 255, 255, 0.1);
				--shadow: rgba(0, 0, 0, 0.3);
				--success: #10b981;
				--warning: #f59e0b;
				--error: #ef4444;
			}

			[data-theme="light"] {
				--bg-primary: #ffffff;
				--bg-secondary: #f8fafc;
				--bg-card: rgba(0, 0, 0, 0.02);
				--text-primary: #1e293b;
				--text-secondary: #64748b;
				--accent-primary: #6366f1;
				--accent-secondary: #8b5cf6;
				--accent-tertiary: #06b6d4;
				--border: rgba(0, 0, 0, 0.1);
				--shadow: rgba(0, 0, 0, 0.1);
				--success: #10b981;
				--warning: #f59e0b;
				--error: #ef4444;
			}

			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
					sans-serif;
				background: var(--bg-primary);
				color: var(--text-primary);
				min-height: 100vh;
				transition: all 0.3s ease;
			}

			.theme-toggle {
				position: fixed;
				top: 2rem;
				right: 2rem;
				z-index: 1000;
				background: var(--bg-card);
				border: 1px solid var(--border);
				border-radius: 50px;
				padding: 0.5rem;
				cursor: pointer;
				transition: all 0.3s ease;
				backdrop-filter: blur(10px);
			}

			.theme-toggle:hover {
				transform: scale(1.1);
				box-shadow: 0 8px 32px var(--shadow);
			}

			.theme-toggle svg {
				width: 24px;
				height: 24px;
				fill: var(--text-primary);
				transition: all 0.3s ease;
			}

			.container {
				max-width: 1200px;
				margin: 0 auto;
				padding: 2rem;
				min-height: 100vh;
			}

			.header {
				text-align: center;
				margin-bottom: 3rem;
				animation: slideDown 0.8s ease-out;
			}

			@keyframes slideDown {
				from {
					opacity: 0;
					transform: translateY(-30px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.header h1 {
				font-size: 3rem;
				font-weight: 700;
				margin-bottom: 1rem;
				background: linear-gradient(
					135deg,
					var(--accent-primary),
					var(--accent-secondary)
				);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
			}

			.header p {
				color: var(--text-secondary);
				font-size: 1.2rem;
				max-width: 600px;
				margin: 0 auto;
			}

			.back-btn {
				background: var(--bg-card);
				color: var(--text-primary);
				border: 1px solid var(--border);
				padding: 0.75rem 1.5rem;
				border-radius: 12px;
				text-decoration: none;
				font-weight: 500;
				transition: all 0.3s ease;
				display: inline-flex;
				align-items: center;
				gap: 0.5rem;
				margin-bottom: 2rem;
				backdrop-filter: blur(10px);
			}

			.back-btn:hover {
				background: var(--accent-primary);
				color: white;
				transform: translateY(-2px);
				box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
			}

			.main-content {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 2rem;
				animation: slideUp 0.8s ease-out 0.2s both;
			}

			@keyframes slideUp {
				from {
					opacity: 0;
					transform: translateY(30px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.upload-section,
			.results-section {
				background: var(--bg-card);
				border: 1px solid var(--border);
				border-radius: 20px;
				padding: 2rem;
				backdrop-filter: blur(20px);
				box-shadow: 0 16px 32px var(--shadow);
			}

			.upload-area {
				border: 2px dashed var(--border);
				border-radius: 16px;
				padding: 3rem 2rem;
				text-align: center;
				cursor: pointer;
				transition: all 0.3s ease;
				background: var(--bg-card);
				margin: 1.5rem 0;
			}

			.upload-area:hover {
				border-color: var(--accent-primary);
				background: rgba(99, 102, 241, 0.05);
				transform: translateY(-2px);
			}

			.btn {
				background: linear-gradient(
					135deg,
					var(--accent-primary),
					var(--accent-secondary)
				);
				color: white;
				border: none;
				padding: 1rem 2rem;
				border-radius: 12px;
				font-weight: 600;
				font-size: 1rem;
				cursor: pointer;
				transition: all 0.3s ease;
				box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
				position: relative;
				overflow: hidden;
				width: 100%;
				margin-top: 1.5rem;
			}

			.btn:hover {
				transform: translateY(-2px);
				box-shadow: 0 16px 48px rgba(99, 102, 241, 0.4);
			}

			.btn:disabled {
				background: var(--text-secondary);
				cursor: not-allowed;
				transform: none;
				box-shadow: none;
			}

			.loading {
				text-align: center;
				padding: 3rem 2rem;
				animation: pulse 2s ease-in-out infinite;
			}

			@keyframes pulse {
				0%,
				100% {
					opacity: 1;
				}
				50% {
					opacity: 0.6;
				}
			}

			.loading-spinner {
				width: 48px;
				height: 48px;
				margin: 0 auto 1rem;
				border: 4px solid var(--border);
				border-top: 4px solid var(--accent-primary);
				border-radius: 50%;
				animation: spin 1s linear infinite;
			}

			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}

			.result-item {
				background: var(--bg-card);
				border: 1px solid var(--border);
				border-radius: 12px;
				padding: 1.5rem;
				margin: 1rem 0;
				transition: all 0.3s ease;
				animation: slideInRight 0.5s ease-out;
			}

			.carousel-controls {
				display: flex;
				gap: 1rem;
				margin-bottom: 1.5rem;
				align-items: center;
				justify-content: center;
			}

			.carousel-btn {
				background: var(--bg-card);
				color: var(--text-primary);
				border: 2px solid var(--border);
				padding: 0.75rem 1.5rem;
				border-radius: 8px;
				cursor: pointer;
				transition: all 0.3s ease;
				font-weight: 500;
				display: flex;
				align-items: center;
				gap: 0.5rem;
			}

			.carousel-btn:hover {
				background: var(--accent-primary);
				color: white;
				border-color: var(--accent-primary);
				transform: translateY(-2px);
			}

			.carousel-btn.active {
				background: var(--accent-primary);
				color: white;
				border-color: var(--accent-primary);
			}

			.carousel-content {
				display: none;
			}

			.carousel-content.active {
				display: block;
			}

			@keyframes slideInRight {
				from {
					opacity: 0;
					transform: translateX(20px);
				}
				to {
					opacity: 1;
					transform: translateX(0);
				}
			}

			.result-item:hover {
				transform: translateY(-2px);
				box-shadow: 0 8px 32px var(--shadow);
			}

			.result-label {
				font-weight: 700;
				color: var(--accent-primary);
				margin-bottom: 0.5rem;
				font-size: 1rem;
				text-transform: uppercase;
				letter-spacing: 0.5px;
			}

			.result-value {
				font-size: 1.1rem;
				line-height: 1.5;
				color: var(--text-primary);
			}

			.secondary-characteristic {
				color: var(--text-secondary);
				font-size: 0.95rem;
				font-weight: 500;
			}

			/* Editable field styles */
			.editable-value {
				background: rgba(255, 255, 255, 0.05);
				border: 1px solid var(--border);
				border-radius: 6px;
				padding: 8px 12px;
				outline: none;
				transition: all 0.3s ease;
				min-height: 24px;
			}

			.editable-value:hover {
				border-color: var(--accent-primary);
				background: rgba(255, 255, 255, 0.08);
			}

			.editable-value:focus {
				border-color: var(--accent-primary);
				background: rgba(255, 255, 255, 0.1);
				box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
			}

			/* Inline editable (for secondary colors/materials) */
			.secondary-characteristic .editable-value {
				background: rgba(255, 255, 255, 0.03);
				border-color: rgba(255, 255, 255, 0.15);
			}

			.secondary-characteristic .editable-value:hover {
				border-color: var(--accent-primary);
				background: rgba(255, 255, 255, 0.06);
			}

			/* Submit button */
			.submit-container {
				margin-top: 2rem;
				padding-top: 2rem;
				border-top: 1px solid var(--border);
				display: flex;
				justify-content: center;
			}

			.submit-btn {
				background: linear-gradient(
					135deg,
					var(--accent-primary),
					var(--accent-secondary)
				);
				color: white;
				border: none;
				padding: 1rem 3rem;
				border-radius: 12px;
				font-size: 1.1rem;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s ease;
				box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
			}

			.submit-btn:hover {
				transform: translateY(-2px);
				box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
			}

			.submit-btn:active {
				transform: translateY(0);
			}

			.submit-btn:disabled {
				background: var(--text-secondary);
				cursor: not-allowed;
				transform: none;
				box-shadow: none;
			}

			/* Success message */
			.success-message {
				text-align: center;
				padding: 2rem;
				animation: fadeIn 0.5s ease;
			}

			.success-message h2 {
				color: var(--success);
				font-size: 2rem;
				margin-bottom: 1rem;
			}

			.success-message p {
				color: var(--text-secondary);
				font-size: 1.1rem;
			}

			.confidence-bar {
				width: 100%;
				height: 4px;
				background: var(--border);
				border-radius: 2px;
				margin-top: 0.5rem;
				overflow: hidden;
			}

			.confidence-fill {
				height: 100%;
				background: linear-gradient(
					90deg,
					var(--accent-primary),
					var(--accent-secondary)
				);
				border-radius: 2px;
				transition: width 0.5s ease;
			}

			.error {
				background: rgba(239, 68, 68, 0.1);
				border: 1px solid var(--error);
				color: var(--error);
				padding: 1.5rem;
				border-radius: 12px;
				margin: 1rem 0;
			}

			@media (max-width: 768px) {
				.main-content {
					grid-template-columns: 1fr;
				}
				.header h1 {
					font-size: 2rem;
				}
				.container {
					padding: 1rem;
				}
			}
		</style>
	</head>
	<body>
		<div class="theme-toggle" onclick="toggleTheme()">
			<svg class="sun-icon" viewBox="0 0 24 24">
				<circle cx="12" cy="12" r="5" />
				<path
					d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
				/>
			</svg>
		</div>

		<div class="container">
			<div class="header">
				<h1>AI Product Analysis</h1>
				<p>
					Upload an image and let our advanced AI analyze and describe the item
					with detailed insights
				</p>
			</div>

			<a href="/" class="back-btn">
				<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
					<path
						d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"
					/>
				</svg>
				Back to Home
			</a>

			<div class="main-content">
				<div class="upload-section">
					<h3 style="margin-bottom: 1.5rem; color: var(--text-primary)">
						Upload Image
					</h3>

					<div
						class="upload-area"
						onclick="document.getElementById('fileInput').click()"
						ondrop="handleDrop(event)"
						ondragover="handleDragOver(event)"
						ondragleave="handleDragLeave(event)"
					>
						<div
							style="
								width: 64px;
								height: 64px;
								margin: 0 auto 1rem;
								background: linear-gradient(
									135deg,
									var(--accent-primary),
									var(--accent-secondary)
								);
								border-radius: 16px;
								display: flex;
								align-items: center;
								justify-content: center;
							"
						>
							<svg
								viewBox="0 0 24 24"
								style="width: 32px; height: 32px; fill: white"
							>
								<path
									d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"
								/>
							</svg>
						</div>
						<p
							style="
								font-size: 1.1rem;
								margin-bottom: 0.5rem;
								color: var(--text-primary);
							"
						>
							<span id="uploadText"
								>Drop your image here or click to browse</span
							>
						</p>
						<p style="color: var(--text-secondary); font-size: 0.9rem">
							Supports JPG, PNG, GIF, WebP â€¢ Max 10MB
						</p>
						<input
							type="file"
							id="fileInput"
							accept="image/*"
							style="display: none"
							onchange="handleFileSelect(event)"
						/>
					</div>

					<div
						id="imagePreview"
						style="
							display: none;
							margin-top: 2rem;
							text-align: center;
							animation: fadeIn 0.5s ease-out;
						"
					>
						<h4 style="margin-bottom: 1rem; color: var(--text-primary)">
							Selected Image
						</h4>
						<img
							id="previewImg"
							style="
								max-width: 100%;
								max-height: 300px;
								border-radius: 16px;
								box-shadow: 0 16px 32px var(--shadow);
								border: 2px solid var(--border);
							"
							alt="Preview"
						/>
					</div>

					<button
						id="generateBtn"
						class="btn"
						onclick="generateDescription()"
						disabled
					>
						Analyze Image
					</button>
				</div>

				<div class="results-section">
					<h3 style="margin-bottom: 1.5rem; color: var(--text-primary)">
						Analysis Results
					</h3>

					<div id="loading" style="display: none">
						<div class="loading">
							<div class="loading-spinner"></div>
							<p id="loadingStatus" style="color: var(--text-secondary)">
								AI is analyzing your image...
							</p>
							<p
								id="loadingSubtext"
								style="
									color: var(--text-secondary);
									font-size: 0.9rem;
									margin-top: 0.5rem;
								"
							>
								This may take 10-30 seconds
							</p>
						</div>
					</div>

					<div id="results" style="display: none">
						<div id="resultContent"></div>
					</div>

					<div
						id="placeholder"
						style="
							text-align: center;
							padding: 3rem 2rem;
							color: var(--text-secondary);
						"
					>
						<svg
							width="64"
							height="64"
							viewBox="0 0 24 24"
							fill="currentColor"
							style="opacity: 0.3; margin-bottom: 1rem"
						>
							<path
								d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M7,13H17V11H7"
							/>
						</svg>
						<p>Upload an image to see AI analysis results here</p>
					</div>
				</div>
			</div>
		</div>

		<script>
			let selectedFile = null;

			// Theme toggle functionality
			function toggleTheme() {
				const html = document.documentElement;
				const currentTheme = html.getAttribute("data-theme");
				const newTheme = currentTheme === "light" ? "dark" : "light";
				html.setAttribute("data-theme", newTheme);
				localStorage.setItem("theme", newTheme);
			}

			// Load saved theme
			const savedTheme = localStorage.getItem("theme") || "dark";
			document.documentElement.setAttribute("data-theme", savedTheme);

			// Drag and drop functionality
			function handleDragOver(event) {
				event.preventDefault();
				event.currentTarget.classList.add("dragover");
			}

			function handleDragLeave(event) {
				event.currentTarget.classList.remove("dragover");
			}

			function handleDrop(event) {
				event.preventDefault();
				event.currentTarget.classList.remove("dragover");
				const files = event.dataTransfer.files;
				if (files.length > 0) {
					selectedFile = files[0];
					updateFileSelection();
				}
			}

			function handleFileSelect(event) {
				selectedFile = event.target.files[0];
				updateFileSelection();
			}

			function updateFileSelection() {
				if (selectedFile) {
					document.getElementById("generateBtn").disabled = false;
					document.getElementById(
						"uploadText"
					).textContent = `Selected: ${selectedFile.name}`;
					document.getElementById("placeholder").style.display = "none";

					// Show image preview
					const reader = new FileReader();
					reader.onload = function (e) {
						document.getElementById("previewImg").src = e.target.result;
						document.getElementById("imagePreview").style.display = "block";
					};
					reader.readAsDataURL(selectedFile);
				}
			}

			async function generateDescription() {
				if (!selectedFile) return;

				const formData = new FormData();
				formData.append("file", selectedFile);

				document.getElementById("loading").style.display = "block";
				document.getElementById("results").style.display = "none";
				document.getElementById("placeholder").style.display = "none";
				document.getElementById("generateBtn").disabled = true;

				// Step 1: Check for multiple objects
				document.getElementById("loadingStatus").textContent =
					"Checking for multiple objects in the image...";
				document.getElementById("loadingSubtext").textContent = "Step 1 of 2";

				let multipleObjectsMsg = "";

				try {
					// First API call - check for multiple objects
					const multipleCheckResponse = await fetch(
						"/api/check-multiple-objects",
						{
							method: "POST",
							body: formData,
						}
					);

					const multipleCheckResult = await multipleCheckResponse.json();

					if (multipleCheckResult.success) {
						const moData = multipleCheckResult.data;
						if (moData.multiple_objects) {
							// Remove trailing period from brief_description if present to avoid double periods
							const desc =
								moData.brief_description?.trim().replace(/\.$/, "") || "items";
							multipleObjectsMsg = `âš ï¸ Multiple objects detected: ${desc}. Analysis may take longer.`;
						} else {
							const desc =
								moData.brief_description?.trim().replace(/\.$/, "") || "item";
							multipleObjectsMsg = `âœ“ Single object detected: ${desc}`;
						}

						// Show the multiple objects result immediately
						const resultContent = document.getElementById("resultContent");
						resultContent.innerHTML = "";
						document.getElementById("results").style.display = "block";

						const msgDiv = document.createElement("div");
						msgDiv.className = "multiple-objects-msg";
						msgDiv.style.cssText = `
							background: var(--bg-card);
							border: 1px solid var(--border);
							border-radius: 12px;
							padding: 1rem;
							margin-bottom: 1.5rem;
							color: var(--text-primary);
							animation: slideInRight 0.5s ease-out;
						`;
						msgDiv.textContent = multipleObjectsMsg;
						resultContent.appendChild(msgDiv);
					}

					// Step 2: Generate full description
					document.getElementById("loadingStatus").textContent =
						"Analyzing item details...";
					document.getElementById("loadingSubtext").textContent = "Step 2 of 2";

					// Create new FormData for second request
					const formData2 = new FormData();
					formData2.append("file", selectedFile);

					// Pass multiple objects data if available
					if (multipleCheckResult.success && multipleCheckResult.data) {
						formData2.append(
							"multiple_objects_json",
							JSON.stringify(multipleCheckResult.data)
						);
					}

					const response = await fetch("/api/generate-description", {
						method: "POST",
						body: formData2,
					});

					const result = await response.json();

					document.getElementById("loading").style.display = "none";
					document.getElementById("generateBtn").disabled = false;

					if (result.success) {
						displayResults(result.data, multipleObjectsMsg);
					} else {
						displayError(result.error, result.raw_response);
					}
				} catch (error) {
					document.getElementById("loading").style.display = "none";
					document.getElementById("generateBtn").disabled = false;
					displayError("Network error: " + error.message);
				}
			}

			// ChatGPT-style typewriter effect
			function typeWriter(element, text, speed = 30) {
				return new Promise((resolve) => {
					let i = 0;
					element.innerHTML = "";
					const timer = setInterval(() => {
						if (i < text.length) {
							element.innerHTML += text.charAt(i);
							i++;
						} else {
							clearInterval(timer);
							resolve();
						}
					}, speed);
				});
			}

			async function displayResults(data, multipleObjectsMsg = "") {
				const resultContent = document.getElementById("resultContent");

				// Check if there's already a multiple objects message, preserve it
				const existingMsg = resultContent.querySelector(
					".multiple-objects-msg"
				);

				resultContent.innerHTML = "";

				// Show results container
				document.getElementById("results").style.display = "block";

				// Re-add the existing message or add a new one
				if (existingMsg) {
					resultContent.appendChild(existingMsg);
				} else if (multipleObjectsMsg) {
					const msgDiv = document.createElement("div");
					msgDiv.className = "multiple-objects-msg";
					msgDiv.style.cssText = `
						background: var(--bg-card);
						border: 1px solid var(--border);
						border-radius: 12px;
						padding: 1rem;
						margin-bottom: 1.5rem;
						color: var(--text-primary);
						animation: slideInRight 0.5s ease-out;
					`;
					msgDiv.textContent = multipleObjectsMsg;
					resultContent.appendChild(msgDiv);
				}

				const globalItems = [];
				const objectItems = [];

				// Handle the new JSON format from your prompt
				if (data.fields) {
					const fields = data.fields;
					const confidence = data.confidence || {};
					const evidence = data.evidence || {};

					// Check if this is multi-object format (arrays)
					const isMultiObject = Array.isArray(fields.brand);

					if (isMultiObject) {
						// MULTIPLE OBJECTS - separate global and per-object details
						const objectCount = fields.brand.length;

						// GLOBAL ITEMS (image-wide info)
						// Always create global items, with fallbacks if data.global is missing
						const globalData = data.global || {};
						globalItems.push(
							{
								label: "Object Count",
								value: globalData.object_count || objectCount,
								confidence: null,
							},
							{
								label: "Print Label",
								value: globalData.print_label ? "Yes" : "No",
								confidence: null,
							},
							{
								label: "OCR Text",
								value: globalData.ocr_text || "None detected",
								confidence: null,
							},
							{
								label: "Visible Marks",
								value: globalData.visible_marks || "None noted",
								confidence: null,
							},
							{
								label: "Needs Review",
								value: globalData.needs_review ? "Yes" : "No",
								confidence: null,
							}
						);

						// OBJECT-SPECIFIC ITEMS (per-object details)
						// Descriptions (one per object)
						if (data.descriptions && Array.isArray(data.descriptions)) {
							data.descriptions.forEach((desc, idx) => {
								objectItems.push({
									label: `Description (Object ${idx + 1})`,
									value: desc || "N/A",
									confidence: null,
								});
							});
						}

						// For each field, create a multi-object item with separate rows
						objectItems.push(
							{
								label: "Brand",
								isMulti: true,
								values: fields.brand,
								confidences: confidence.brand,
							},
							{
								label: "Model",
								isMulti: true,
								values: fields.model,
								confidences: confidence.model,
							},
							{
								label: "Quantity",
								isMulti: true,
								values: fields.quantity,
								confidences: confidence.quantity,
							},
							{
								label: "Condition",
								isMulti: true,
								values: fields.condition,
								confidences: confidence.condition,
							},
							{
								label: "Color",
								isMulti: true,
								values: fields.colour,
								confidences: confidence.colour,
							},
							{
								label: "Material",
								isMulti: true,
								values: fields.material,
								confidences: confidence.material,
							},
							{
								label: "Category",
								isMulti: true,
								values: fields.category,
								confidences: confidence.category,
							},
							{
								label: "Additional Info",
								isMulti: true,
								values: fields.additional_info,
								confidences: null,
							}
						);
					} else {
						// SINGLE OBJECT - also use carousel for consistency
						const globalData = data.evidence || {};

						// GLOBAL ITEMS
						globalItems.push(
							{
								label: "Object Count",
								value: 1,
								confidence: null,
							},
							{
								label: "Print Label",
								value: fields.print_label ? "Yes" : "No",
								confidence: null,
							},
							{
								label: "OCR Text",
								value: globalData.ocr_like_text || "None detected",
								confidence: null,
							},
							{
								label: "Visible Marks",
								value: globalData.visible_marks || "None noted",
								confidence: null,
							},
							{
								label: "Needs Review",
								value: data.needs_review ? "Yes" : "No",
								confidence: null,
							}
						);

						// OBJECT-SPECIFIC ITEMS
						// Build color value with secondary
						let colorValue = fields.colour || "N/A";
						if (
							fields.colour_secondary &&
							fields.colour_secondary.color &&
							fields.colour_secondary.color !== "null" &&
							fields.colour_secondary.percentage > 0
						) {
							colorValue += ` + ${fields.colour_secondary.color} (${fields.colour_secondary.percentage}%)`;
						}

						// Build material value with secondary
						let materialValue = fields.material || "N/A";
						if (
							fields.material_secondary &&
							fields.material_secondary.material &&
							fields.material_secondary.material !== "null" &&
							fields.material_secondary.percentage > 0
						) {
							materialValue += ` + ${fields.material_secondary.material} (${fields.material_secondary.percentage}%)`;
						}

						objectItems.push(
							{
								label: "Description",
								value: data.description || "N/A",
								confidence: null,
							},
							{
								label: "Brand",
								value: fields.brand || "Not identified",
								confidence: confidence.brand,
							},
							{
								label: "Model",
								value: fields.model || "Not identified",
								confidence: confidence.model,
							},
							{
								label: "Quantity",
								value: fields.quantity || 1,
								confidence: confidence.quantity,
							},
							{
								label: "Condition",
								value: fields.condition || "N/A",
								confidence: confidence.condition,
							},
							{
								label: "Color",
								value: colorValue,
								confidence: confidence.colour,
								hasSecondary:
									fields.colour_secondary?.color &&
									fields.colour_secondary.color !== "null" &&
									fields.colour_secondary.percentage > 0,
							},
							{
								label: "Material",
								value: materialValue,
								confidence: confidence.material,
								hasSecondary:
									fields.material_secondary?.material &&
									fields.material_secondary.material !== "null" &&
									fields.material_secondary.percentage > 0,
							},
							{
								label: "Category",
								value: fields.category || "N/A",
								confidence: confidence.category,
							},
							{
								label: "Weight",
								value: fields.weight?.value
									? `${fields.weight.value} ${fields.weight.unit}`
									: "Not specified",
								confidence: confidence.weight,
							},
							{
								label: "Print Label",
								value: fields.print_label ? "Yes" : "No",
								confidence: confidence.print_label,
							},
							{
								label: "Sort Classification",
								value: fields.sort || "N/A",
								confidence: confidence.sort,
							},
							{
								label: "Additional Info",
								value: fields.additional_info || "N/A",
								confidence: null,
							}
						);
					}
				} else {
					// Fallback for old format (single object with old structure)
					objectItems.push(
						{ label: "Title", value: data.title || "N/A", confidence: null },
						{
							label: "Description",
							value: data.description || "N/A",
							confidence: null,
						},
						{
							label: "Condition",
							value: data.condition || "N/A",
							confidence: null,
						},
						{ label: "Color", value: data.color || "N/A", confidence: null },
						{
							label: "Material",
							value: data.material || "N/A",
							confidence: null,
						},
						{
							label: "Category",
							value: data.category || "N/A",
							confidence: null,
						},
						{
							label: "Confidence",
							value: `${data.confidence || "N/A"}/10`,
							confidence: null,
						},
						{
							label: "Evidence",
							value: data.evidence || "N/A",
							confidence: null,
						}
					);
				}

				// Check if we need carousel (multi-object with global items)
				const needsCarousel = globalItems.length > 0 && objectItems.length > 0;

				if (needsCarousel) {
					// Create carousel controls
					const carouselControls = document.createElement("div");
					carouselControls.className = "carousel-controls";

					const globalBtn = document.createElement("button");
					globalBtn.className = "carousel-btn active";
					globalBtn.innerHTML = "ðŸ“Š Global Details";
					globalBtn.onclick = () => switchCarousel("global");

					const objectBtn = document.createElement("button");
					objectBtn.className = "carousel-btn";
					objectBtn.innerHTML = "ðŸ” Per-Object Details";
					objectBtn.onclick = () => switchCarousel("objects");

					carouselControls.appendChild(globalBtn);
					carouselControls.appendChild(objectBtn);
					resultContent.appendChild(carouselControls);

					// Create global content container
					const globalContainer = document.createElement("div");
					globalContainer.id = "globalContent";
					globalContainer.className = "carousel-content active";
					resultContent.appendChild(globalContainer);

					// Create object content container
					const objectContainer = document.createElement("div");
					objectContainer.id = "objectContent";
					objectContainer.className = "carousel-content";
					resultContent.appendChild(objectContainer);

					// Render global items
					await renderItems(globalItems, globalContainer, true); // Global items editable

					// Render object items
					await renderItems(objectItems, objectContainer, true); // Object items editable

					// Add submit button after object items
					addSubmitButton(objectContainer, data);
				} else {
					// No carousel needed - single object or old format
					await renderItems(objectItems, resultContent, true); // Object items editable

					// Add submit button
					addSubmitButton(resultContent, data);
				}
			}

			function switchCarousel(tab) {
				const buttons = document.querySelectorAll(".carousel-btn");
				const contents = document.querySelectorAll(".carousel-content");

				buttons.forEach((btn) => btn.classList.remove("active"));
				contents.forEach((content) => content.classList.remove("active"));

				if (tab === "global") {
					buttons[0].classList.add("active");
					document.getElementById("globalContent").classList.add("active");
				} else {
					buttons[1].classList.add("active");
					document.getElementById("objectContent").classList.add("active");
				}
			}

			async function renderItems(items, container, editable = false) {
				// Animate each result item
				for (let i = 0; i < items.length; i++) {
					const item = items[i];

					if (item.isMulti && item.values) {
						// MULTI-OBJECT ITEM - create card with multiple rows
						const resultDiv = document.createElement("div");
						resultDiv.className = "result-item";
						resultDiv.style.animationDelay = `${i * 0.1}s`;

						const labelDiv = document.createElement("div");
						labelDiv.className = "result-label";
						labelDiv.textContent = item.label;
						resultDiv.appendChild(labelDiv);

						// Container for all object rows
						const valuesContainer = document.createElement("div");
						valuesContainer.className = "result-value";
						valuesContainer.style.display = "flex";
						valuesContainer.style.flexDirection = "column";
						valuesContainer.style.gap = "0.75rem";

						// Create a row for each object
						item.values.forEach((val, objIdx) => {
							const rowDiv = document.createElement("div");
							rowDiv.style.display = "flex";
							rowDiv.style.flexDirection = "column";
							rowDiv.style.gap = "0.5rem";

							const objectLabel = document.createElement("div");
							objectLabel.style.fontSize = "0.85rem";
							objectLabel.style.color = "var(--accent-primary)";
							objectLabel.style.fontWeight = "500";
							objectLabel.textContent = `Object ${objIdx + 1}:`;

							const objectValue = document.createElement("div");
							objectValue.textContent = val || "N/A";
							if (editable) {
								objectValue.contentEditable = "true";
								objectValue.className = "editable-value";
								objectValue.dataset.field = item.label;
								objectValue.dataset.objectIndex = objIdx;
							}

							rowDiv.appendChild(objectLabel);
							rowDiv.appendChild(objectValue);

							// Add confidence bar if available
							if (
								item.confidences &&
								item.confidences[objIdx] !== null &&
								item.confidences[objIdx] !== undefined
							) {
								const confidenceBar = document.createElement("div");
								confidenceBar.className = "confidence-bar";
								const confidenceFill = document.createElement("div");
								confidenceFill.className = "confidence-fill";
								confidenceFill.style.width = "0%";
								confidenceBar.appendChild(confidenceFill);
								rowDiv.appendChild(confidenceBar);

								// Animate confidence bar
								setTimeout(() => {
									confidenceFill.style.width = `${(
										item.confidences[objIdx] * 100
									).toFixed(0)}%`;
								}, (i + 1) * 200 + 500);
							}

							valuesContainer.appendChild(rowDiv);
						});

						resultDiv.appendChild(valuesContainer);
						container.appendChild(resultDiv);
						await new Promise((resolve) => setTimeout(resolve, i * 100));
					} else {
						// SINGLE VALUE ITEM - original logic
						const resultDiv = document.createElement("div");
						resultDiv.className = "result-item";
						resultDiv.style.animationDelay = `${i * 0.1}s`;

						const labelDiv = document.createElement("div");
						labelDiv.className = "result-label";
						labelDiv.textContent = item.label;

						const valueDiv = document.createElement("div");
						valueDiv.className = "result-value";
						if (editable) {
							valueDiv.contentEditable = "true";
							valueDiv.classList.add("editable-value");
							valueDiv.dataset.field = item.label;
						}

						resultDiv.appendChild(labelDiv);
						resultDiv.appendChild(valueDiv);

						if (item.confidence !== null && item.confidence !== undefined) {
							const confidenceBar = document.createElement("div");
							confidenceBar.className = "confidence-bar";
							const confidenceFill = document.createElement("div");
							confidenceFill.className = "confidence-fill";
							confidenceFill.style.width = "0%";
							confidenceBar.appendChild(confidenceFill);
							resultDiv.appendChild(confidenceBar);

							// Animate confidence bar after text
							setTimeout(() => {
								confidenceFill.style.width = `${(item.confidence * 100).toFixed(
									0
								)}%`;
							}, (i + 1) * 200 + 500);
						}

						container.appendChild(resultDiv);

						// Typewriter effect for each value
						await new Promise((resolve) => setTimeout(resolve, i * 100));

						// Handle secondary characteristics styling
						if (item.hasSecondary && item.value.includes(" + ")) {
							const parts = item.value.split(" + ");
							const primaryPart = parts[0];
							const secondaryPart = parts[1]; // e.g., "black (20%)"

							await typeWriter(valueDiv, primaryPart, 20);

							// Parse secondary part to separate editable name from non-editable percentage
							const secondaryMatch = secondaryPart.match(
								/^([^(]+)\s*\((\d+%)\)$/
							);
							if (secondaryMatch && editable) {
								// Editable secondary color/material name, non-editable percentage
								const secondaryName = secondaryMatch[1].trim();
								const secondaryPercentage = secondaryMatch[2];

								const secondarySpan = document.createElement("span");
								secondarySpan.className = "secondary-characteristic";
								secondarySpan.textContent = " + ";

								const editableSecondary = document.createElement("span");
								editableSecondary.contentEditable = "true";
								editableSecondary.className = "editable-value";
								editableSecondary.style.display = "inline";
								editableSecondary.style.padding = "2px 6px";
								editableSecondary.style.minHeight = "auto";
								editableSecondary.textContent = secondaryName;
								editableSecondary.dataset.field = `${item.label} Secondary`;

								const percentageSpan = document.createElement("span");
								percentageSpan.contentEditable = "false";
								percentageSpan.textContent = ` (${secondaryPercentage})`;
								percentageSpan.style.userSelect = "none";

								secondarySpan.appendChild(editableSecondary);
								secondarySpan.appendChild(percentageSpan);
								valueDiv.appendChild(secondarySpan);
							} else {
								// Non-editable or no match
								const secondarySpan = document.createElement("span");
								secondarySpan.className = "secondary-characteristic";
								secondarySpan.textContent = " + " + secondaryPart;
								if (editable) {
									secondarySpan.contentEditable = "false";
								}
								valueDiv.appendChild(secondarySpan);
							}
						} else {
							// Convert value to string to handle numbers properly
							await typeWriter(valueDiv, String(item.value), 20);
						}
					}
				}
			}

			function displayError(error, rawResponse = "") {
				const resultContent = document.getElementById("resultContent");
				resultContent.innerHTML = `
                <div class="error">
                    <h4>Error occurred:</h4>
                    <p>${error}</p>
                    ${
											rawResponse
												? `<details style="margin-top: 1rem;"><summary>Raw Response</summary><pre style="margin-top: 0.5rem; font-size: 0.8rem; white-space: pre-wrap;">${rawResponse}</pre></details>`
												: ""
										}
                </div>
            `;
				document.getElementById("results").style.display = "block";
			}

			function addSubmitButton(container, originalData) {
				const submitContainer = document.createElement("div");
				submitContainer.className = "submit-container";

				const submitBtn = document.createElement("button");
				submitBtn.className = "submit-btn";
				submitBtn.textContent = "âœ“ Submit to Database";
				submitBtn.onclick = () => submitReviewedData(originalData);

				submitContainer.appendChild(submitBtn);
				container.appendChild(submitContainer);
			}

			async function submitReviewedData(originalData) {
				const submitBtn = document.querySelector(".submit-btn");
				submitBtn.disabled = true;
				submitBtn.textContent = "â³ Submitting...";

				try {
					// Collect all edited field values
					const editableFields = document.querySelectorAll(".editable-value");
					const editedData = { ...originalData };

					// Process editable fields
					editableFields.forEach((field) => {
						const fieldName = field.dataset.field;
						const objectIndex = field.dataset.objectIndex;
						const value = field.textContent.trim();

						// TODO: Update editedData based on field name and object index
						// This will depend on your data structure
					});

					// Submit to database (placeholder - replace with actual API call)
					await new Promise((resolve) => setTimeout(resolve, 1500)); // Simulate API call

					// Show success message
					const resultContent = document.getElementById("resultContent");
					resultContent.innerHTML = `
					<div class="success-message">
						<h2>âœ“ All Details Reviewed</h2>
						<p>Successfully submitted to database!</p>
						<p style="margin-top: 1rem;">Ready for next image...</p>
					</div>
				`;

					// Clear the page after 2 seconds
					setTimeout(() => {
						// Reset the form
						document.getElementById("imageInput").value = "";
						document.getElementById("previewImage").style.display = "none";
						document.getElementById("results").style.display = "none";
						document.getElementById("resultContent").innerHTML = "";
					}, 2000);
				} catch (error) {
					submitBtn.disabled = false;
					submitBtn.textContent = "âœ“ Submit to Database";
					alert("Error submitting data: " + error.message);
				}
			}
		</script>
	</body>
</html>
